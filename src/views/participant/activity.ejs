<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SID2026 - Activity</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <h1>Activity: <%= activityId %></h1>
        <div id="activity-content">
            <% if (activityId === 'password-poll') { %>
                <%- include('../activities/password-poll', { step: 0 }) %>
            <% } else if (activityId === 'phishing') { %>
                <%- include('../activities/phishing') %>
            <% } else if (activityId === 'tracking-poll') { %>
                <%- include('../activities/tracking-poll') %>
            <% } else if (activityId === 'real-or-ai') { %>
                <%- include('../activities/real-or-ai', { step: 0 }) %>
            <% } else if (activityId === 'misinformation') { %>
                <%- include('../activities/misinformation') %>
            <% } else if (activityId === 'verdict-vote') { %>
                <%- include('../activities/verdict-vote') %>
            <% } else { %>
                <p>UNKNOWN_ACTIVITY_MODULE: <%= activityId %></p>
            <% } %>
        </div>
        <form id="response-form" action="/activity/<%= activityId %>/respond" method="POST">
            <!-- Form inputs will be injected via JS or server-side logic -->
            <button type="submit">Submit</button>
        </form>
    </div>
    <script src="/js/firebase.js"></script>
    <script type="module">
        import { db, doc, onSnapshot } from "/js/db.js";
        
        const sessionId = "default-session";
        const currentActivityId = "<%= activityId %>";

        console.log(">> ACTIVITY_SESSION_INITIATED: " + currentActivityId);

        onSnapshot(doc(db, "sessions", sessionId), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const serverActivity = data.currentActivity;
                
                if (!serverActivity || serverActivity === "none") {
                    console.log(">> SESSION_TERMINATED. RETURNING_TO_LOBBY.");
                    window.location.href = "/lobby";
                } else if (serverActivity !== currentActivityId) {
                    console.log(">> ACTIVITY_CHANGED: " + serverActivity);
                    window.location.href = "/activity/" + serverActivity;
                }
            }
        });
    </script>
</body>
</html>
